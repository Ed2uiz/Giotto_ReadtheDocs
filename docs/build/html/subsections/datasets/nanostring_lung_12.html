<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nanostring CosMx Subcellular Lung Cancer &mdash; Giotto 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx-toolbox-code.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/sphinx-toolbox.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme_edits.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/tabs.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/sphinx_toolbox_installation.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme_edits.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
        <script src="../../_static/sphinx_toolbox_installation.js"></script>
        <script src="../../_static/design-tabs.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html">
            <img src="../../_static/GiottoLogo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">General</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../gettingstarted.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../documentation.html">Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contribute</a></li>
<li class="toctree-l1"><a class="reference external" href="http://spatial.rc.fas.harvard.edu/giotto-viewer/">Giotto Viewer [work-in-progress]</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faqs.html">FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trygiotto.html">Try Giotto</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Issues</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../errorsfaqsandtips.html">Common Errors and Solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../github_issues.html">Report a Bug</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Giotto</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Nanostring CosMx Subcellular Lung Cancer</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/subsections/datasets/nanostring_lung_12.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="nanostring-cosmx-subcellular-lung-cancer">
<h1>Nanostring CosMx Subcellular Lung Cancer<a class="headerlink" href="#nanostring-cosmx-subcellular-lung-cancer" title="Permalink to this headline"></a></h1>
<p>This example uses subcellular data from Nanostring’s CosMx Spatial Molecular Imager. This publicly available dataset, which can be found <cite>here &lt;https://www.nanostring.com/products/cosmx-spatial-molecular-imager/ffpe-dataset/&gt;`__</cite> is from a FFPE sample of non-small-cell lung cancer.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example works with Lung12.</p>
</div>
<section id="start-giotto">
<h2>Start Giotto<a class="headerlink" href="#start-giotto" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load Giotto, data.table is also necessary for this example</span>
<span class="n">library</span><span class="p">(</span><span class="n">Giotto</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
<span class="c1"># add color palettes if you want!</span>
<span class="n">library</span><span class="p">(</span><span class="n">rcartocolor</span><span class="p">)</span>
<span class="n">pal</span> <span class="o">&lt;-</span> <span class="n">carto_pal</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;Pastel&quot;</span><span class="p">)</span>

<span class="c1"># set working directory</span>
<span class="n">results_folder</span> <span class="o">=</span> <span class="s1">&#39;/path/to/directory&#39;</span>

<span class="c1"># set giotto python path</span>
<span class="c1"># set python path to your preferred python version path</span>
<span class="c1"># set python path to NULL if you want to automatically install (only the 1st time) and use the giotto miniconda environment</span>
<span class="n">python_path</span> <span class="o">=</span> <span class="n">NULL</span>
<span class="k">if</span><span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">python_path</span><span class="p">))</span> <span class="p">{</span>
<span class="n">installGiottoEnvironment</span><span class="p">()</span>
<span class="p">}</span>


<span class="c1">## create instructions</span>
<span class="c1"># by directly saving plots, but not rendering them you will save a lot of time</span>
<span class="n">instrs</span> <span class="o">=</span> <span class="n">createGiottoInstructions</span><span class="p">(</span><span class="n">save_dir</span> <span class="o">=</span> <span class="n">results_folder</span><span class="p">,</span>
                <span class="n">save_plot</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
                <span class="n">show_plot</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span>
                <span class="n">return_plot</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="load-in-data">
<h2>2. Load in Data<a class="headerlink" href="#load-in-data" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## provide path to nanostring folder</span>
<span class="n">data_path</span> <span class="o">=</span> <span class="s1">&#39;/path/to/data/Lung12-Flat_files_and_images/&#39;</span>

<span class="c1"># load transcript coordinates</span>
<span class="n">tx_coord_all</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;Lung12_tx_file-002.csv&#39;</span><span class="p">))</span>

<span class="c1">#  load field of vision (fov) positions</span>
<span class="n">fov_offset_file</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;Lung12_fov_positions_file.csv&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Choose field of vision for analysis</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gobjects_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="c1"># select which FOV&#39;s you would like to work with</span>
<span class="c1"># the dataset includes 28, which is too much for most computers to handle at once.</span>
<span class="c1">#For this example I am using 02, 03, and 04</span>
<span class="n">id_set</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;02&#39;</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">,</span> <span class="s1">&#39;04&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="create-a-giotto-object-for-each-fov">
<h2>3. Create a Giotto Object for each FOV<a class="headerlink" href="#create-a-giotto-object-for-each-fov" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span><span class="p">(</span><span class="n">fov_i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">id_set</span><span class="p">))</span> <span class="p">{</span>

<span class="n">fov_id</span> <span class="o">=</span> <span class="n">id_set</span><span class="p">[</span><span class="n">fov_i</span><span class="p">]</span>


<span class="c1"># 1. original composite image as png</span>
<span class="n">original_composite_image</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;CellComposite/CellComposite_F0&#39;</span><span class="p">,</span> <span class="n">fov_id</span><span class="p">,</span><span class="s1">&#39;.jpg&#39;</span><span class="p">)</span>

<span class="c1"># 2. input cell segmentation as mask file</span>
<span class="n">segmentation_mask</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;CellLabels/CellLabels_F0&#39;</span><span class="p">,</span> <span class="n">fov_id</span><span class="p">,</span> <span class="s1">&#39;.tif&#39;</span><span class="p">)</span>

<span class="c1"># 3. input features coordinates + offset</span>
<span class="n">tx_coord</span> <span class="o">=</span> <span class="n">tx_coord_all</span><span class="p">[</span><span class="n">fov</span> <span class="o">==</span> <span class="k">as</span><span class="o">.</span><span class="n">numeric</span><span class="p">(</span><span class="n">fov_id</span><span class="p">)]</span>
<span class="n">tx_coord</span> <span class="o">=</span> <span class="n">tx_coord</span><span class="p">[,</span><span class="o">.</span><span class="p">(</span><span class="n">x_local_px</span><span class="p">,</span> <span class="n">y_local_px</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">target</span><span class="p">)]</span>
<span class="n">colnames</span><span class="p">(</span><span class="n">tx_coord</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;gene_id&#39;</span><span class="p">)</span>
<span class="n">tx_coord</span> <span class="o">=</span> <span class="n">tx_coord</span><span class="p">[,</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">gene_id</span><span class="p">)]</span>


<span class="n">fovsubset</span> <span class="o">=</span> <span class="n">createGiottoObjectSubcellular</span><span class="p">(</span><span class="n">gpoints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;rna&#39;</span> <span class="o">=</span> <span class="n">tx_coord</span><span class="p">),</span>
                        <span class="n">gpolygons</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;cell&#39;</span> <span class="o">=</span> <span class="n">segmentation_mask</span><span class="p">),</span>
                        <span class="n">polygon_mask_list_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mask_method</span> <span class="o">=</span> <span class="s1">&#39;guess&#39;</span><span class="p">,</span>
                                        <span class="n">flip_vertical</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
                                        <span class="n">flip_horizontal</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span>
                                        <span class="n">shift_horizontal_step</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">),</span>
                        <span class="n">instructions</span> <span class="o">=</span> <span class="n">instrs</span><span class="p">)</span>


<span class="c1"># centroids are now used to provide the spatial locations (centroid of each cell)</span>
<span class="n">fovsubset</span> <span class="o">=</span> <span class="n">addSpatialCentroidLocations</span><span class="p">(</span><span class="n">fovsubset</span><span class="p">,</span>
                    <span class="n">poly_info</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">)</span>

<span class="c1"># create and add Giotto images</span>
<span class="n">composite</span> <span class="o">=</span> <span class="n">createGiottoLargeImage</span><span class="p">(</span><span class="n">raster_object</span> <span class="o">=</span> <span class="n">original_composite_image</span><span class="p">,</span>
                    <span class="n">negative_y</span> <span class="o">=</span> <span class="n">FALSE</span><span class="p">,</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;composite&#39;</span><span class="p">)</span>

<span class="n">fovsubset</span> <span class="o">=</span> <span class="n">addGiottoImage</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fovsubset</span><span class="p">,</span>
                <span class="n">largeImages</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">composite</span><span class="p">))</span>


<span class="n">fovsubset</span> <span class="o">=</span> <span class="n">convertGiottoLargeImageToMG</span><span class="p">(</span><span class="n">giottoLargeImage</span> <span class="o">=</span> <span class="n">composite</span><span class="p">,</span>
                    <span class="c1">#mg_name = &#39;composite&#39;,</span>
                    <span class="n">gobject</span> <span class="o">=</span> <span class="n">fovsubset</span><span class="p">,</span>
                    <span class="n">return_gobject</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span>

<span class="n">gobjects_list</span><span class="p">[[</span><span class="n">fov_i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">fovsubset</span>


<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="join-giotto-objects">
<h2>4. Join Giotto Objects<a class="headerlink" href="#join-giotto-objects" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>new_names = paste0(&quot;fov0&quot;, id_set)

 id_match = match(as.numeric(id_set), fov_offset_file$fov)
 x_shifts = fov_offset_file[id_match]$x_global_px
 y_shifts = fov_offset_file[id_match]$y_global_px

 # Create Giotto object that includes all selected FOVs
 fov_join = joinGiottoObjects(gobject_list = gobjects_list,
                 gobject_names = new_names,
                 join_method = &#39;shift&#39;,
                 x_shift = x_shifts,
                 y_shift = y_shifts)

 showGiottoImageNames(fov_join)

 image_names = paste0(new_names, &#39;-image&#39;)
</pre></div>
</div>
</section>
<section id="visualize-cells-and-genes-of-interest">
<h2>5. Visualize Cells and Genes of Interest<a class="headerlink" href="#visualize-cells-and-genes-of-interest" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spatInSituPlotPoints</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span>
         <span class="n">show_image</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
         <span class="n">image_name</span> <span class="o">=</span> <span class="n">image_names</span><span class="p">,</span>
         <span class="n">feats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;rna&#39;</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;MMP2&quot;</span><span class="p">,</span> <span class="s2">&quot;VEGFA&quot;</span><span class="p">,</span> <span class="s2">&quot;IGF1R&quot;</span><span class="p">,</span> <span class="s1">&#39;CDH2&#39;</span><span class="p">,</span> <span class="s1">&#39;MKI67&#39;</span><span class="p">,</span> <span class="s1">&#39;EPCAM&#39;</span><span class="p">)),</span>
         <span class="n">spat_unit</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
         <span class="n">point_size</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
         <span class="n">show_polygon</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
         <span class="n">use_overlap</span> <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
         <span class="n">polygon_feat_type</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
         <span class="n">polygon_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
         <span class="n">polygon_line_size</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
         <span class="n">coord_fix_ratio</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
         <span class="n">background_color</span> <span class="o">=</span> <span class="n">NA</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/Rplot1.png" src="../../_images/Rplot1.png" />
<section id="visualize-cells">
<h3>Visualize Cells<a class="headerlink" href="#visualize-cells" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spatPlot2D</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span>
       <span class="n">image_name</span> <span class="o">=</span> <span class="n">image_names</span><span class="p">,</span>
       <span class="n">show_image</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
       <span class="n">point_size</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">,</span>
       <span class="n">coord_fix_ratio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/Rplot2.png" src="../../_images/Rplot2.png" />
</section>
</section>
<section id="extract-data-from-your-giotto-object">
<h2>6. Extract Data from your Giotto Object<a class="headerlink" href="#extract-data-from-your-giotto-object" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fov_join</span> <span class="o">=</span> <span class="n">calculateOverlapRaster</span><span class="p">(</span><span class="n">fov_join</span><span class="p">)</span>

<span class="n">fov_join</span> <span class="o">=</span> <span class="n">overlapToMatrix</span><span class="p">(</span><span class="n">fov_join</span><span class="p">)</span>

<span class="n">showGiottoExpression</span><span class="p">(</span><span class="n">fov_join</span><span class="p">)</span>

<span class="c1"># combine cell data</span>
<span class="n">morphometa</span> <span class="o">=</span> <span class="n">combineCellData</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span> <span class="n">feat_type</span> <span class="o">=</span> <span class="s1">&#39;rna&#39;</span><span class="p">)</span>

<span class="c1"># combine feature data</span>
<span class="n">featmeta</span> <span class="o">=</span> <span class="n">combineFeatureData</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span> <span class="n">feat_type</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;rna&#39;</span><span class="p">))</span>

<span class="c1"># combine overlapping feature data</span>
<span class="n">featoverlapmeta</span> <span class="o">=</span> <span class="n">combineFeatureOverlapData</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span>
                        <span class="n">feat_type</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;rna&#39;</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="process-giotto-object">
<h2>7. Process Giotto Object<a class="headerlink" href="#process-giotto-object" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># filter</span>
<span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">filterGiotto</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span>
            <span class="n">expression_threshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">feat_det_in_min_cells</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">min_det_feats_per_cell</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>

<span class="c1">#normalize</span>
<span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">normalizeGiotto</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span> <span class="n">scalefactor</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span>
<span class="c1"># add statistics</span>
<span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">addStatistics</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">)</span>

<span class="c1"># View cellular data</span>
<span class="n">pDataDT</span><span class="p">(</span><span class="n">fov_join</span><span class="p">)</span>
<span class="c1"># View rna data</span>
<span class="n">fDataDT</span><span class="p">(</span><span class="n">fov_join</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="view-transcript-number-distribution">
<h2>8. View Transcript Number Distribution<a class="headerlink" href="#view-transcript-number-distribution" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cellmeta = pDataDT(fov_join, feat_type = &#39;rna&#39;)
hist(cellmeta$nr_feats, 100)
</pre></div>
</div>
<img alt="../../_images/Rplothist.png" src="../../_images/Rplothist.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spatPlot2D</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span>
       <span class="n">cell_color</span> <span class="o">=</span> <span class="s1">&#39;total_expr&#39;</span><span class="p">,</span> <span class="n">color_as_factor</span> <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
       <span class="n">show_image</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
       <span class="n">image_name</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;fov002-image&#39;</span><span class="p">,</span> <span class="s1">&#39;fov003-image&#39;</span><span class="p">,</span> <span class="s1">&#39;fov004-image&#39;</span><span class="p">),</span>
       <span class="n">point_size</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">point_alpha</span> <span class="o">=</span> <span class="mf">0.75</span><span class="p">,</span> <span class="n">coord_fix_ratio</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/Rplot3.png" src="../../_images/Rplot3.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spatInSituPlotPoints</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span>
         <span class="n">show_polygon</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
         <span class="n">polygon_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
         <span class="n">polygon_line_size</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
         <span class="n">polygon_fill</span> <span class="o">=</span> <span class="s1">&#39;total_expr&#39;</span><span class="p">,</span>
         <span class="n">polygon_fill_as_factor</span> <span class="o">=</span> <span class="n">F</span><span class="p">,</span>
         <span class="n">coord_fix_ratio</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/Rplot5.png" src="../../_images/Rplot5.png" />
</section>
<section id="dimension-reduction">
<h2>1. Dimension Reduction<a class="headerlink" href="#dimension-reduction" title="Permalink to this headline"></a></h2>
<section id="calculate-highly-variable-genes">
<h3>Calculate Highly Variable Genes<a class="headerlink" href="#calculate-highly-variable-genes" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># typical way of calculating HVG</span>
<span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">calculateHVF</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span> <span class="n">HVFname</span> <span class="o">=</span> <span class="s1">&#39;hvg_orig&#39;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/4-HVFplot.png" src="../../_images/4-HVFplot.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># new method based on variance of pearson residuals for each gene</span>
<span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">calculateHVF</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span>
            <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;var_p_resid&#39;</span><span class="p">,</span>
            <span class="n">expression_values</span> <span class="o">=</span> <span class="s1">&#39;pearson&#39;</span><span class="p">,</span>
            <span class="n">show_plot</span> <span class="o">=</span> <span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/5-HVFplot.png" src="../../_images/5-HVFplot.png" />
</section>
<section id="view-highly-variable-features">
<h3>View Highly Variable Features<a class="headerlink" href="#view-highly-variable-features" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gene_meta</span> <span class="o">=</span> <span class="n">fDataDT</span><span class="p">(</span><span class="n">fov_join</span><span class="p">)</span>
<span class="n">gene_meta</span><span class="p">[</span><span class="n">hvf</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="run-pca">
<h3>Run PCA<a class="headerlink" href="#run-pca" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">runPCA</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span>
           <span class="n">expression_values</span> <span class="o">=</span> <span class="s1">&#39;pearson&#39;</span><span class="p">,</span>
           <span class="n">scale_unit</span> <span class="o">=</span> <span class="n">F</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span>
<span class="n">screePlot</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span> <span class="n">ncp</span> <span class="o">=</span> <span class="mi">20</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/6-screePlot.png" src="../../_images/6-screePlot.png" />
</section>
<section id="plot-pca">
<h3>Plot PCA<a class="headerlink" href="#plot-pca" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plotPCA</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span>
    <span class="n">dim1_to_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">dim2_to_use</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/7-PCA.png" src="../../_images/7-PCA.png" />
</section>
<section id="run-umap">
<h3>Run UMAP<a class="headerlink" href="#run-umap" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">runUMAP</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span> <span class="n">dimensions_to_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_threads</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">plotUMAP</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/8-UMAP.png" src="../../_images/8-UMAP.png" />
</section>
</section>
<section id="cluster">
<h2>10. Cluster<a class="headerlink" href="#cluster" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">createNearestNetwork</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span> <span class="n">dimensions_to_use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">fov_join</span> <span class="o">&lt;-</span> <span class="n">doLeidenCluster</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span> <span class="n">n_iterations</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># visualize UMAP cluster results</span>
<span class="n">plotUMAP</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span> <span class="n">cell_color</span> <span class="o">=</span> <span class="s1">&#39;leiden_clus&#39;</span><span class="p">,</span>
    <span class="n">show_NN_network</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span> <span class="n">point_size</span> <span class="o">=</span> <span class="mf">2.5</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/9-UMAP.png" src="../../_images/9-UMAP.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># visualize UMAP and spatial results</span>
<span class="n">spatDimPlot2D</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span>
        <span class="n">show_image</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
        <span class="n">image_name</span> <span class="o">=</span> <span class="n">image_names</span><span class="p">,</span>
        <span class="n">cell_color</span> <span class="o">=</span> <span class="s1">&#39;leiden_clus&#39;</span><span class="p">,</span>
        <span class="n">spat_point_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/10-spatDimPlot2D.png" src="../../_images/10-spatDimPlot2D.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spatInSituPlotPoints</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span>
         <span class="n">feats</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="s1">&#39;rna&#39;</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;MMP2&quot;</span><span class="p">,</span> <span class="s2">&quot;VEGFA&quot;</span><span class="p">,</span> <span class="s2">&quot;IGF1R&quot;</span><span class="p">,</span> <span class="s1">&#39;CDH2&#39;</span><span class="p">,</span> <span class="s1">&#39;MKI67&#39;</span><span class="p">,</span> <span class="s1">&#39;EPCAM&#39;</span><span class="p">)),</span>
         <span class="n">point_size</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span>
         <span class="n">show_polygon</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
         <span class="n">polygon_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
         <span class="n">polygon_line_size</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
         <span class="n">polygon_fill</span> <span class="o">=</span> <span class="s1">&#39;leiden_clus&#39;</span><span class="p">,</span>
         <span class="n">polygon_fill_as_factor</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
         <span class="n">coord_fix_ratio</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/spatinsituclustered.png" src="../../_images/spatinsituclustered.png" />
</section>
<section id="small-subset-visiualization">
<h2>11. Small Subset Visiualization<a class="headerlink" href="#small-subset-visiualization" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>locs &lt;-fov_join@spatial_locs$cell$raw

#subset a Giotto object based on spatial locations
smallfov &lt;- subsetGiottoLocs(fov_join,
            x_max = 800,
            x_min = 507,
            y_max = -158800,
            y_min = -159600)

#extract all genes observed in new object
smallfeats &lt;- smallfov@feat_metadata$cell$rna$feat_ID

#plot all genes
spatInSituPlotPoints(test,
            feats = list(testfeats),
            point_size = 0.15,
            polygon_line_size = .1,
            show_polygon = T,
            polygon_color = &#39;white&#39;,
            show_image = T,
            image_name = image_names,
            coord_fix_ratio = TRUE,
            show_legend = FALSE)
</pre></div>
</div>
<img alt="../../_images/12-spatInSituPlotPoints.png" src="../../_images/12-spatInSituPlotPoints.png" />
</section>
<section id="spatial-expression-patterns">
<h2>12. Spatial Expression Patterns<a class="headerlink" href="#spatial-expression-patterns" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># create spatial network based on physical distance of cell centroids
fov_join = createSpatialNetwork(gobject = fov_join, minimum_k = 2,
                maximum_distance_delaunay = 50)

# select features
feats = fov_join@feat_ID$rna
# perform Binary Spatial Extraction of genes - NOTE: Depending on your system this could take time
km_spatialgenes = binSpect(fov_join, subset_feats = feats)

# visualize spatial expression of selected genes obtained from binSpect
spatFeatPlot2D(fov_join, expression_values = &#39;scaled&#39;,
        feats = km_spatialgenes$feats[1:10],
        cell_color_gradient = c(&#39;blue&#39;, &#39;white&#39;, &#39;red&#39;),
        point_shape = &#39;border&#39;, point_border_stroke = 0.01,
        show_network = F, network_color = &#39;lightgrey&#39;, point_size = 1.2,
        cow_n_col = 2)
</pre></div>
</div>
<img alt="../../_images/13-spatFeatPlot2D.png" src="../../_images/13-spatFeatPlot2D.png" />
</section>
<section id="identify-clusters">
<h2>13. Identify Clusters<a class="headerlink" href="#identify-clusters" title="Permalink to this headline"></a></h2>
<section id="violin-plot">
<h3>Violin Plot<a class="headerlink" href="#violin-plot" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>markers = findMarkers_one_vs_all(gobject = fov_join,
                 method = &#39;gini&#39;,
                 expression_values = &#39;normalized&#39;,
                 cluster_column = &#39;leiden_clus&#39;,
                 min_feats = 1, rank_score = 2)
markers[, head(.SD, 5), by = &#39;cluster&#39;]

# violinplot
topgini_genes = unique(markers[, head(.SD, 2), by = &#39;cluster&#39;]$feats)
violinPlot(fov_join, feats = topgini_genes, cluster_column = &#39;leiden_clus&#39;, strip_position = &#39;right&#39;)
</pre></div>
</div>
<img alt="../../_images/14-violinPlot.png" src="../../_images/14-violinPlot.png" />
</section>
<section id="heatmap">
<h3>Heatmap<a class="headerlink" href="#heatmap" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cluster_order</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">plotMetaDataHeatmap</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span> <span class="n">expression_values</span> <span class="o">=</span> <span class="s1">&#39;scaled&#39;</span><span class="p">,</span>
            <span class="n">metadata_cols</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;leiden_clus&#39;</span><span class="p">),</span>
            <span class="n">selected_feats</span> <span class="o">=</span> <span class="n">topgini_genes</span><span class="p">,</span>
            <span class="n">custom_cluster_order</span> <span class="o">=</span> <span class="n">cluster_order</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/6-plotMetaDataHeatmap.png" src="../../_images/6-plotMetaDataHeatmap.png" />
</section>
<section id="annotate-giotto-object">
<h3>Annotate Giotto Object<a class="headerlink" href="#annotate-giotto-object" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">## add cell types ###</span>
<span class="n">clusters_cell_types_lung</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s1">&#39;Normal Epithelial&#39;</span><span class="p">,</span> <span class="s1">&#39;Cancer&#39;</span><span class="p">,</span> <span class="s1">&#39;Stromal&#39;</span><span class="p">,</span> <span class="s1">&#39;Plasma Cells&#39;</span><span class="p">,</span><span class="s1">&#39;Cytotoxic T Cells&#39;</span><span class="p">,</span> <span class="s1">&#39;Cancer Stem Cells&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Macrophage&#39;</span><span class="p">,</span> <span class="s1">&#39;Memory B Cell&#39;</span><span class="p">,</span> <span class="s1">&#39;Memory B Cell&#39;</span><span class="p">)</span>

<span class="n">names</span><span class="p">(</span><span class="n">clusters_cell_types_lung</span><span class="p">)</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">character</span><span class="p">(</span><span class="n">sort</span><span class="p">(</span><span class="n">cluster_order</span><span class="p">))</span>
<span class="n">fov_join</span> <span class="o">=</span> <span class="n">annotateGiotto</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span> <span class="n">annotation_vector</span> <span class="o">=</span> <span class="n">clusters_cell_types_lung</span><span class="p">,</span> <span class="n">cluster_column</span> <span class="o">=</span> <span class="s1">&#39;leiden_clus&#39;</span><span class="p">)</span>

<span class="n">plotUMAP</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span> <span class="n">cell_color</span> <span class="o">=</span> <span class="s1">&#39;cell_types&#39;</span><span class="p">,</span> <span class="n">point_size</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">cell_color_code</span> <span class="o">=</span> <span class="n">colorcode</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/15-UMAP.png" src="../../_images/15-UMAP.png" />
</section>
<section id="visualize">
<h3>Visualize<a class="headerlink" href="#visualize" title="Permalink to this headline"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spatDimPlot2D</span><span class="p">(</span><span class="n">gobject</span> <span class="o">=</span> <span class="n">fov_join</span><span class="p">,</span>
      <span class="n">show_image</span> <span class="o">=</span> <span class="n">T</span><span class="p">,</span>
      <span class="n">image_name</span> <span class="o">=</span> <span class="n">image_names</span><span class="p">,</span>
      <span class="n">cell_color</span> <span class="o">=</span> <span class="s1">&#39;cell_types&#39;</span><span class="p">,</span>
      <span class="n">spat_point_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/16-spatDimPlot2D.png" src="../../_images/16-spatDimPlot2D.png" />
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">spatInSituPlotPoints</span><span class="p">(</span><span class="n">fov_join</span><span class="p">,</span>
         <span class="n">show_polygon</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span>
         <span class="n">polygon_feat_type</span> <span class="o">=</span> <span class="s1">&#39;cell&#39;</span><span class="p">,</span>
         <span class="n">polygon_color</span> <span class="o">=</span> <span class="s1">&#39;white&#39;</span><span class="p">,</span>
         <span class="n">polygon_line_size</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
         <span class="n">polygon_fill</span> <span class="o">=</span> <span class="s1">&#39;cell_types&#39;</span><span class="p">,</span>
         <span class="n">polygon_fill_as_factor</span> <span class="o">=</span> <span class="n">T</span> <span class="p">,</span>
         <span class="n">polygon_fill_code</span> <span class="o">=</span> <span class="n">colorcode</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/17-spatInSituPlotPoints.png" src="../../_images/17-spatInSituPlotPoints.png" />
</section>
</section>
<section id="interaction-changed-genes">
<h2>14. Interaction Changed Genes<a class="headerlink" href="#interaction-changed-genes" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>future::plan(&#39;multisession&#39;, workers = 4) # NOTE: Depending on your system this could take time

goi = findInteractionChangedFeats(gobject = fov_join,
                cluster_column = &#39;leiden_clus&#39;)

# Identify top ten interaction changed genes
goi$CPGscores[type_int == &#39;hetero&#39;]$feats[1:10]

# Visualize ICG expression
spatInSituPlotPoints(fov_join,
            feats = list(testy$CPGscores[type_int == &#39;hetero&#39;]$feats[1:10]),
            point_size = 0.6,
            show_polygon = TRUE,
            polygon_feat_type = &#39;cell&#39;,
            polygon_color = &#39;black&#39;,
            polygon_line_size = 0.1,
            polygon_fill = &#39;cell_types&#39;,
            polygon_fill_as_factor = T,
            polygon_fill_code = pal)
</pre></div>
</div>
<img alt="../../_images/18-spatInSituPlotPoints.png" src="../../_images/18-spatInSituPlotPoints.png" />
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Ruben Dries, Qian Zhu, Huipeng Li, Rui Dong, Guo-Cheng Yuan.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>