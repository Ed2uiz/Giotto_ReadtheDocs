---
title: "Interoperability: AnnData"
format: rst
date: 2023-04-14
number-sections: true
---

## Converting to and from AnnData (squidpy-flavor)
This tutorial details how to use the conversion functions `anndataToGiotto()` and
`giottoToAnnData()`. A mini Giotto object will be used for minimal computational requirements.
Please note that these functions are inherently in active development, since changes to 
either squidpy or anndata are possible. 

## Start Giotto
```{r eval=TRUE, message=FALSE}
# Ensure Giotto Suite is installed
if(!"Giotto" %in% installed.packages()) {
  devtools::install_github("drieslab/Giotto@Suite")
}
library(Giotto)

# Ensure Giotto Data is installed
if(!"GiottoData" %in% installed.packages()) {
  devtools::install_github("drieslab/GiottoData")
}
library(GiottoData)

# Ensure the Python environment for Giotto has been installed
genv_exists = checkGiottoEnvironment()
if(!genv_exists){
  # The following command need only be run once to install the Giotto environment
  installGiottoEnvironment()
}
```

## Create a Giotto object
```{r eval=TRUE}
# Specify path to which results may be saved
results_directory = paste0(getwd(),'/giotto_anndata_conversion/') 

# Optional: Specify a path to a Python executable within a conda or miniconda 
# environment. If set to NULL (default), the Python executable within the previously
# installed Giotto environment will be used.
my_python_path = NULL # alternatively, "/local/python/path/python" if desired.

mini_gobject = loadGiottoMini(dataset = 'vizgen', 
                              python_path = my_python_path)

instrs = showGiottoInstructions(mini_gobject)
instrs$save_dir = results_directory

mini_gobject = replaceGiottoInstructions(gobject = mini_gobject,
                                         instructions = instrs)
```

## Convert Giotto to AnnData

Since Giotto is structured hierarchally, converting Giotto to AnnData will result in 
multiple `.h5ad` files. Each file will correspond to a Giotto `spat_unit` `feat_type` pair.
Furthermore, each expression slot will be treated as a `layer` in the resulting AnnData slot.

Squidpy anndata objects take different defaults for various operations compared to Giotto.
For instance, the default nearest neighbor network is a kNN for squidpy, while the default 
for Giotto is a sNN. We'll create a kNN in addition to the sNN within this object already 
to show how it they are handled.

```{r eval=TRUE}
mini_gobject = createNearestNetwork(gobject = mini_gobject,
                                    spat_unit = "aggregate",
                                    feat_type = "rna",
                                    type = "kNN",
                                    dim_reduction_to_use = "umap",
                                    dim_reduction_name = "umap",
                                    k = 15,
                                    name = "kNN.umap")
```

The above cell creates a nearest network with almost all default parameters. We'll change some 
and make a new network to show how the converter handles this.


```{r eval=TRUE}
mini_gobject = createNearestNetwork(gobject = mini_gobject,
                                    spat_unit = "aggregate",
                                    feat_type = "rna",
                                    type = "kNN",
                                    dim_reduction_to_use = "umap",
                                    dim_reduction_name = "umap",
                                    k = 6,
                                    name = "new_network")
```


Since we have multiple `spat_unit` `feat_type` pairs, there will be multiple files created by
this function. The names of the `.h5ad` files will be returned. In the case of a non-anndata-default 
nearest network or spatial network name, the key_added terms will be recorded and saved in `.txt` files
named accordingly. Please see the documentation for further details.

```{r eval=TRUE}
anndata_conversions = giottoToAnnData(gobject = mini_gobject,
                                      save_directory = results_directory,
                                      python_path = my_python_path)
```


## AnnData to Giotto

To convert an AnnData Object back into a Giotto object, it must first be saved as a `.h5ad` file. 
The name of said file may then be provided to `anndataToGiotto()` for conversion.

If a nearest neighbor network or spatial netowkr was created using the `key_added` argument, they may be
provided to arguments n_key_added and/or spatial_n_key_added, respectively. If converting an anndata object that was 
originally a giotto object, the `.txt` files generated by `giottoToAnnData()` may be provided to these arguments as well.

```{r eval=TRUE}
z0_rna_gobject <- anndataToGiotto(anndata_path = "./giotto_anndata_conversion/z0_rna_converted_gobject.h5ad",
                                  python_path = my_python_path)

z1_rna_gobject <- anndataToGiotto(anndata_path = "./giotto_anndata_conversion/z1_rna_converted_gobject.h5ad",
                                  python_path = my_python_path)

aggregate_rna_gobject <- anndataToGiotto(anndata_path = "./giotto_anndata_conversion/aggregate_rna_converted_gobject.h5ad",
                                         python_path = my_python_path,
                                         n_key_added = list("sNN.pca","new_network"),
                                         spatial_n_key_added = "aggregate_rna_spatial_network_keys_added.txt")
```

## Session Info
```{r}
sessionInfo()
```
